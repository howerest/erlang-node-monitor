<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF8" />
    <title>erlang node monitor</title>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/vis-network@9.1.0/standalone/umd/vis-network.js"
    ></script>

    <style type="text/css">
      body {
        font-family: monospace;
        background: #efefef;
      }

      h2 { margin: 0 }
      h4 { margin: 0 }

      #nodes {
        width: 100%;
        height: 800px;
        border: 1px solid lightgray;
        background: white;
      }

      div.nodeContent {
        background: white;
        position: relative;
        border: 1px solid lightgray;
        width: 20%;
        height: 780px;
        margin-top: -802px;
        margin-left: 80%;
        padding: 10px;
      }

      pre {
        padding: 5px;
        margin: 5px;
      }

      *:focus {
        outline: 0 !important;
      }
    </style>
  </head>

  <body>
    <div>
      <h2>erlang node monitor</h2>
      <div id="node-name"></div>
    </div>

    <div id="nodes"></div>
    <div class="nodeContent">
      <h4>Selected node:</h4>
      <pre id="nodeContent"></pre>
    </div>

    <script type="text/javascript">
      var network;
      var nodes = new vis.DataSet();
      var edges = new vis.DataSet();
      var gephiImported;
      var nodeContent = document.getElementById("nodeContent");
      var container = document.getElementById("nodes");
      var data = {
        nodes: nodes,
        edges: edges,
      };
      var options = {
        layout: {
          hierarchical: {
    				enabled: true,
    				levelSeparation: 200,
    				nodeSpacing: 200
    			}
        },
        nodes: {
          font: {
            face: "monospace"
          },
          color: {
            highlight: "black"
          }
        },
        edges: {
          width: 5,
          smooth: {
            type: "continuous",
          },
          color: "#333333"
        },
        interaction: {
          tooltipDelay: 400,
          hideEdgesOnDrag: true
        }
      };

      network = new vis.Network(container, data, options);

      network.on("click", function (params) {
        if (params.nodes.length > 0) {
          var data = nodes.get(params.nodes[0]);
          nodeContent.innerText = JSON.stringify(data, undefined, 3); // show the data in the div
        }
      });

      function addNewProcess(node) {
        try {
          var id = node.id.join('.');
          var isSupervisor = node.name.indexOf("_sup") !== -1;
          var data = {
            id,
            label: node.name ? node.name : id,
            title: `pid: ${id}`,
            shape: isSupervisor ? "hexagon" : "dot",
            color: {
              color: isSupervisor ? "white" : "black",
              background: isSupervisor ? "red" : "green",
            },
            links: node.links.map(function(l) { return l.join('.') })
          };

          nodes.add(data);

          // add an edge for each node link
          for (var i = 0; i < node.links.length; i++) {
            node.links[i];
            var edgesDataSet = edges.getDataSet();
            if (edgesDataSet.get({ filter: function(i) { return i.to === id }}).length === 0) {
              var newEdge = {
                id: edgesDataSet.length+1,
                from: id,
                to: node.links[i].join('.'),
              };
              edges.add(newEdge);
            }
          }
        } catch (err) {
          alert(err);
        }
      }

      websocket = new WebSocket('ws://localhost:5000/');

      websocket.onopen = function(evt) {
        console.log('- sent message to server: '+'greet');
        websocket.send(JSON.stringify({ msg: 'greet' }));
      };

      websocket.onmessage = function(evt) {
        try {
          var payload = JSON.parse(evt.data);
          document.getElementById("node-name").innerText = payload.node;
          for (var i = 0; i < payload.processes.length; i++) {
            console.log('- adding node: ', payload.processes[i]);
            addNewProcess(payload.processes[i]);
          }
        } catch(e) {
          alert(e);
        }
      };

      websocket.onerror = function(evt) {
       console.log(evt);
      };
    </script>
  </body>
</html>
